<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° SOLVING NAVIGATOR</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: #f9fafb;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      font-weight: 600;
    }
    @keyframes slideIn {
      from { transform: translateX(400px) scale(0.8); opacity: 0; }
      to { transform: translateX(0) scale(1); opacity: 1; }
    }
    .tab-button {
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    .tab-button:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }
    .card {
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    input[type="text"], input[type="password"], select, textarea {
      text-transform: uppercase;
      transition: all 0.2s;
    }
    input[type="text"]:focus, input[type="password"]:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .score-card {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      position: relative;
      overflow: hidden;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .gradient-bg {
      background: #f9fafb;
      position: relative;
      min-height: 100vh;
    }
    .neon-border {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .problem-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }
    .problem-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    .master-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }
    .master-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div id="app"></div>
  <script>
    // ‚ö†Ô∏è MASUKKAN SUPABASE URL DAN ANON KEY KAMU DI SINI
    const SUPABASE_URL = "https://utqjiwmdjgcjyvcqqcqq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0cWppd21kamdjanl2Y3FxY3FxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3NjU0MTAsImV4cCI6MjA4MTM0MTQxMH0.Xa1m9G2sjzNAdgxmDpE0NYjPCd0G7N8yIpCuBxkXIF4";

    const ADMIN_PASSWORD = "ADMIN123!";

    let supabase = null;
    let appData = {
      problems: [],
      masters: [],
      history: []
    };
    let currentTab = 'dashboard';
    let isAuthenticated = false;
    let inactivityTimer = null;
    let formData = {
      inisial_personil: '',
      departemen: '',
      mesin: '',
      nama_produk: '',
      kategori_problem: '',
      judul_problem: '',
      investigasi: '',
      foto_kejadian: '',
      action: '',
      foto_perbaikan: '',
      evaluasi: ''
    };
    let masterData = {
      departemen: [],
      area: [],
      proses: [],
      mesin: []
    };
    let filters = {
      departemen: '',
      mesin: '',
      area: '',
      proses: ''
    };

    function initSupabase() {
      if (SUPABASE_URL && SUPABASE_ANON_KEY && SUPABASE_URL !== "YOUR_SUPABASE_URL_HERE" && SUPABASE_ANON_KEY !== "YOUR_SUPABASE_ANON_KEY_HERE") {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        loadData();
        return true;
      }
      return false;
    }

    async function loadData() {
      if (!supabase) return;
      
      try {
        const { data: problems, error: problemError } = await supabase
          .from('problems')
          .select('*')
          .order('created_at', { ascending: false });

        const { data: masters, error: masterError } = await supabase
          .from('master_data')
          .select('*')
          .order('created_at', { ascending: false });

        const { data: history, error: historyError } = await supabase
          .from('history')
          .select('*')
          .order('created_at', { ascending: false });

        if (!problemError && !masterError && !historyError) {
          appData = {
            problems: problems || [],
            masters: masters || [],
            history: history || []
          };
          getMasterDataFromRecords();
          renderApp();
        }
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 'bg-gradient-to-r from-red-500 to-rose-600'} text-white`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function toUpperCase(str) {
      return str ? str.toUpperCase() : '';
    }

    function getMasterDataFromRecords() {
      if (!appData.masters) return;
      masterData.departemen = [...new Set(appData.masters.map(r => r.departemen).filter(Boolean))];
      masterData.area = [...new Set(appData.masters.map(r => r.area).filter(Boolean))];
      masterData.proses = [...new Set(appData.masters.map(r => r.proses).filter(Boolean))];
      masterData.mesin = [...new Set(appData.masters.map(r => r.mesin).filter(Boolean))];
    }

    function getProblems() {
      return appData.problems || [];
    }

    function getFilteredProblems() {
      let problems = getProblems();
      if (filters.departemen) problems = problems.filter(p => p.departemen === filters.departemen);
      if (filters.mesin) problems = problems.filter(p => p.mesin === filters.mesin);
      if (filters.area) problems = problems.filter(p => p.area === filters.area);
      if (filters.proses) problems = problems.filter(p => p.proses === filters.proses);
      return problems;
    }

    function calculateScores() {
      const problems = getFilteredProblems();
      const total = problems.length;
      const quality = problems.filter(p => p.kategori_problem === 'QUALITY').length;
      const productivity = problems.filter(p => p.kategori_problem === 'PRODUCTIVITY').length;
      const safety = problems.filter(p => p.kategori_problem === 'SAFETY').length;
      return { total, quality, productivity, safety };
    }

    function resetInactivityTimer() {
      if (inactivityTimer) clearTimeout(inactivityTimer);
      if (currentTab === 'manage' && isAuthenticated) {
        inactivityTimer = setTimeout(() => {
          isAuthenticated = false;
          showToast('Sesi berakhir karena tidak ada aktivitas', 'error');
          renderApp();
        }, 20000);
      }
    }

    async function handleImageUpload(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
      });
    }

    async function submitProblem() {
      if (!supabase) {
        showToast('Supabase belum dikonfigurasi!', 'error');
        return;
      }

      if (!formData.inisial_personil || !formData.departemen || !formData.kategori_problem || !formData.judul_problem) {
        showToast('Mohon lengkapi field yang wajib diisi', 'error');
        return;
      }

      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> MENYIMPAN...';

      const masterRecord = appData.masters.find(r => 
        r.departemen === formData.departemen && 
        r.mesin === formData.mesin
      );

      const newRecord = {
        inisial_personil: toUpperCase(formData.inisial_personil),
        departemen: toUpperCase(formData.departemen),
        mesin: toUpperCase(formData.mesin),
        area: masterRecord ? toUpperCase(masterRecord.area) : '',
        proses: masterRecord ? toUpperCase(masterRecord.proses) : '',
        nama_produk: toUpperCase(formData.nama_produk),
        kategori_problem: toUpperCase(formData.kategori_problem),
        judul_problem: toUpperCase(formData.judul_problem),
        investigasi: toUpperCase(formData.investigasi),
        foto_kejadian: formData.foto_kejadian,
        action: toUpperCase(formData.action),
        foto_perbaikan: formData.foto_perbaikan,
        evaluasi: toUpperCase(formData.evaluasi),
        created_at: new Date().toISOString()
      };

      const { data, error } = await supabase
        .from('problems')
        .insert([newRecord])
        .select();
      
      if (!error) {
        await supabase
          .from('history')
          .insert([{
            activity_description: `Problem baru ditambahkan: ${newRecord.judul_problem}`,
            departemen: newRecord.departemen,
            mesin: newRecord.mesin,
            kategori_problem: newRecord.kategori_problem,
            created_at: new Date().toISOString()
          }]);
        
        formData = {
          inisial_personil: '',
          departemen: '',
          mesin: '',
          nama_produk: '',
          kategori_problem: '',
          judul_problem: '',
          investigasi: '',
          foto_kejadian: '',
          action: '',
          foto_perbaikan: '',
          evaluasi: ''
        };
        showToast('‚úÖ Problem berhasil disimpan!');
        currentTab = 'dashboard';
        await loadData();
      } else {
        showToast('‚ùå Gagal menyimpan problem: ' + error.message, 'error');
        btn.disabled = false;
        btn.textContent = 'SIMPAN PROBLEM';
      }
    }

    async function submitMasterData(data) {
      if (!supabase) {
        showToast('Supabase belum dikonfigurasi!', 'error');
        return;
      }

      const btn = document.getElementById('master-submit-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> MENYIMPAN...';

      const newRecord = {
        departemen: toUpperCase(data.departemen),
        area: toUpperCase(data.area),
        proses: toUpperCase(data.proses),
        mesin: toUpperCase(data.mesin),
        created_at: new Date().toISOString()
      };

      const { error } = await supabase
        .from('master_data')
        .insert([newRecord]);
      
      if (!error) {
        await supabase
          .from('history')
          .insert([{
            activity_description: `Master data ditambahkan: ${newRecord.departemen} - ${newRecord.mesin}`,
            departemen: newRecord.departemen,
            mesin: newRecord.mesin,
            created_at: new Date().toISOString()
          }]);
        
        showToast('‚úÖ Master data berhasil disimpan!');
        resetInactivityTimer();
        await loadData();
      } else {
        showToast('‚ùå Gagal menyimpan master data: ' + error.message, 'error');
        btn.disabled = false;
        btn.textContent = 'SIMPAN';
      }
    }

    async function deleteMasterRecord(record) {
      if (!supabase) return;

      const container = document.getElementById(`master-${record.id}`);
      const deleteBtn = container.querySelector('.delete-confirm-btn');
      
      if (deleteBtn.textContent === 'üóëÔ∏è HAPUS') {
        deleteBtn.textContent = '‚ö†Ô∏è KONFIRMASI HAPUS?';
        deleteBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
        deleteBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
        setTimeout(() => {
          if (deleteBtn && deleteBtn.textContent === '‚ö†Ô∏è KONFIRMASI HAPUS?') {
            deleteBtn.textContent = 'üóëÔ∏è HAPUS';
            deleteBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            deleteBtn.classList.add('bg-red-600', 'hover:bg-red-700');
          }
        }, 3000);
        return;
      }

      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<span class="loading"></span> MENGHAPUS...';

      const { error } = await supabase
        .from('master_data')
        .delete()
        .eq('id', record.id);
      
      if (!error) {
        await supabase
          .from('history')
          .insert([{
            activity_description: `Master data dihapus: ${record.departemen} - ${record.mesin}`,
            departemen: record.departemen,
            mesin: record.mesin,
            created_at: new Date().toISOString()
          }]);
        
        showToast('‚úÖ Master data berhasil dihapus!');
        resetInactivityTimer();
        await loadData();
      } else {
        showToast('‚ùå Gagal menghapus master data: ' + error.message, 'error');
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'üóëÔ∏è HAPUS';
      }
    }

    function toggleEditMaster(recordId) {
      const deptField = document.getElementById(`dept-${recordId}`);
      const areaField = document.getElementById(`area-${recordId}`);
      const prosesField = document.getElementById(`proses-${recordId}`);
      const mesinField = document.getElementById(`mesin-${recordId}`);
      const editBtn = document.getElementById(`master-${recordId}`).querySelector('.edit-btn');
      
      if (deptField.disabled) {
        deptField.disabled = false;
        areaField.disabled = false;
        prosesField.disabled = false;
        mesinField.disabled = false;
        
        deptField.style.background = 'white';
        areaField.style.background = 'white';
        prosesField.style.background = 'white';
        mesinField.style.background = 'white';
        
        editBtn.textContent = 'üíæ SIMPAN';
        editBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        editBtn.classList.add('bg-green-600', 'hover:bg-green-700');
      } else {
        const record = appData.masters.find(r => r.id === recordId);
        updateMasterRecord(record, {
          departemen: deptField.value,
          area: areaField.value,
          proses: prosesField.value,
          mesin: mesinField.value
        });
      }
      resetInactivityTimer();
    }

    async function updateMasterRecord(record, updates) {
      if (!supabase) return;

      const btn = document.getElementById(`master-${record.id}`).querySelector('.edit-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> MENYIMPAN...';

      const updateData = {
        departemen: toUpperCase(updates.departemen),
        area: toUpperCase(updates.area),
        proses: toUpperCase(updates.proses),
        mesin: toUpperCase(updates.mesin)
      };
      
      const { error } = await supabase
        .from('master_data')
        .update(updateData)
        .eq('id', record.id);
      
      if (!error) {
        await supabase
          .from('history')
          .insert([{
            activity_description: `Master data diupdate: ${updateData.departemen} - ${updateData.mesin}`,
            departemen: updateData.departemen,
            mesin: updateData.mesin,
            created_at: new Date().toISOString()
          }]);
        
        showToast('‚úÖ Master data berhasil diupdate!');
        resetInactivityTimer();
        await loadData();
      } else {
        showToast('‚ùå Gagal mengupdate master data: ' + error.message, 'error');
        btn.disabled = false;
        btn.textContent = 'üíæ SIMPAN';
      }
    }

    function renderDashboard() {
      getMasterDataFromRecords();
      const scores = calculateScores();
      const problems = getFilteredProblems();

      if (!supabase) {
        return `
          <div class="rounded-xl p-8 shadow-2xl text-center neon-border bg-white">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">‚ö†Ô∏è KONFIGURASI SUPABASE</h2>
            <p class="text-base mb-4 text-gray-600">Silakan masukkan Supabase URL dan Anon Key di dalam kode.</p>
            <p class="text-sm text-gray-500">Edit konstanta SUPABASE_URL dan SUPABASE_ANON_KEY di bagian script.</p>
          </div>
        `;
      }

      return `
        <div class="space-y-6">
          <div class="rounded-2xl p-8 text-white shadow-2xl neon-border" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
            <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
              üîç FILTER DATA
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label class="block mb-2 font-bold text-sm" for="filter-departemen">üìÇ DEPARTEMEN</label>
                <select id="filter-departemen" class="w-full px-4 py-3 rounded-xl border-2 border-white/30 text-base" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white;" onchange="filters.departemen = this.value; renderApp();">
                  <option value="" style="color: #1e293b;">SEMUA</option>
                  ${masterData.departemen.map(d => `<option value="${d}" ${filters.departemen === d ? 'selected' : ''} style="color: #1e293b;">${d}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block mb-2 font-bold text-sm" for="filter-mesin">‚öôÔ∏è MESIN</label>
                <select id="filter-mesin" class="w-full px-4 py-3 rounded-xl border-2 border-white/30 text-base" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white;" onchange="filters.mesin = this.value; renderApp();">
                  <option value="" style="color: #1e293b;">SEMUA</option>
                  ${masterData.mesin.map(m => `<option value="${m}" ${filters.mesin === m ? 'selected' : ''} style="color: #1e293b;">${m}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block mb-2 font-bold text-sm" for="filter-area">üìç AREA</label>
                <select id="filter-area" class="w-full px-4 py-3 rounded-xl border-2 border-white/30 text-base" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white;" onchange="filters.area = this.value; renderApp();">
                  <option value="" style="color: #1e293b;">SEMUA</option>
                  ${masterData.area.map(a => `<option value="${a}" ${filters.area === a ? 'selected' : ''} style="color: #1e293b;">${a}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block mb-2 font-bold text-sm" for="filter-proses">üîß PROSES</label>
                <select id="filter-proses" class="w-full px-4 py-3 rounded-xl border-2 border-white/30 text-base" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white;" onchange="filters.proses = this.value; renderApp();">
                  <option value="" style="color: #1e293b;">SEMUA</option>
                  ${masterData.proses.map(p => `<option value="${p}" ${filters.proses === p ? 'selected' : ''} style="color: #1e293b;">${p}</option>`).join('')}
                </select>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="score-card rounded-2xl p-8 text-white shadow-2xl">
              <div class="text-sm opacity-90 mb-2 font-bold">üìä TOTAL PROBLEM</div>
              <div class="text-5xl font-black">${scores.total}</div>
            </div>
            <div class="rounded-2xl p-8 text-white shadow-2xl" style="background: linear-gradient(135deg, #2563eb 0%, #fb923c 100%);">
              <div class="text-sm opacity-90 mb-2 font-bold">‚ú® QUALITY</div>
              <div class="text-5xl font-black">${scores.quality}</div>
            </div>
            <div class="rounded-2xl p-8 text-white shadow-2xl" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
              <div class="text-sm opacity-90 mb-2 font-bold">‚ö° PRODUCTIVITY</div>
              <div class="text-5xl font-black">${scores.productivity}</div>
            </div>
            <div class="rounded-2xl p-8 text-white shadow-2xl" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
              <div class="text-sm opacity-90 mb-2 font-bold">üõ°Ô∏è SAFETY</div>
              <div class="text-5xl font-black">${scores.safety}</div>
            </div>
          </div>

          <div class="rounded-2xl p-8 shadow-2xl neon-border bg-white">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-3 text-gray-800">
              üìã DETAIL PROBLEM
            </h3>
            <div class="space-y-4">
              ${problems.length === 0 ? `<p class="text-center py-12 opacity-70 text-gray-600">Belum ada problem yang tercatat</p>` : ''}
              ${problems.map(p => `
                <div class="problem-card card p-6 rounded-2xl shadow-lg">
                  <div class="flex justify-between items-start mb-4">
                    <div>
                      <h4 class="text-xl font-bold mb-2 text-gray-800">${p.judul_problem}</h4>
                      <p class="text-sm opacity-60 text-gray-600">üïê ${new Date(p.created_at).toLocaleString('id-ID')}</p>
                    </div>
                    <span class="px-4 py-2 rounded-full text-white text-xs font-black shadow-lg" style="background: ${p.kategori_problem === 'QUALITY' ? 'linear-gradient(135deg, #f59e0b 0%, #fb923c 100%)' : p.kategori_problem === 'PRODUCTIVITY' ? 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}">${p.kategori_problem}</span>
                  </div>
                  <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                    <div class="flex items-center gap-2">
                      <span class="font-bold text-gray-700">üë§ Personil:</span>
                      <span class="font-semibold text-blue-600">${p.inisial_personil}</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="font-bold text-gray-700">üìÇ Departemen:</span>
                      <span class="font-semibold text-blue-600">${p.departemen}</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="font-bold text-gray-700">‚öôÔ∏è Mesin:</span>
                      <span class="font-semibold text-blue-600">${p.mesin}</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="font-bold text-gray-700">üì¶ Produk:</span>
                      <span class="font-semibold text-blue-600">${p.nama_produk}</span>
                    </div>
                  </div>
                  ${p.investigasi ? `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                      <span class="font-bold flex items-center gap-2 mb-2 text-gray-700">üîç Investigasi:</span>
                      <p class="opacity-80 text-gray-600">${p.investigasi}</p>
                    </div>
                  ` : ''}
                  ${p.action ? `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                      <span class="font-bold flex items-center gap-2 mb-2 text-gray-700">‚úÖ Action:</span>
                      <p class="opacity-80 text-gray-600">${p.action}</p>
                    </div>
                  ` : ''}
                  ${p.evaluasi ? `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                      <span class="font-bold flex items-center gap-2 mb-2 text-gray-700">‚≠ê Evaluasi:</span>
                      <p class="opacity-80 text-gray-600">${p.evaluasi}</p>
                    </div>
                  ` : ''}
                  ${p.foto_kejadian || p.foto_perbaikan ? `
                    <div class="mt-4 pt-4 border-t border-gray-200 flex gap-3">
                      ${p.foto_kejadian ? `<img src="${p.foto_kejadian}" alt="Foto Kejadian" class="w-32 h-32 object-cover rounded-xl shadow-lg border-2 border-red-500" onerror="this.style.display='none'; this.alt='Gagal memuat gambar';">` : ''}
                      ${p.foto_perbaikan ? `<img src="${p.foto_perbaikan}" alt="Foto Perbaikan" class="w-32 h-32 object-cover rounded-xl shadow-lg border-2 border-green-500" onerror="this.style.display='none'; this.alt='Gagal memuat gambar';">` : ''}
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderInput() {
      if (!supabase) {
        return `<div class="rounded-2xl p-8 shadow-2xl text-center neon-border bg-white">
          <p class="text-gray-600">‚ö†Ô∏è Supabase belum dikonfigurasi</p>
        </div>`;
      }

      getMasterDataFromRecords();

      return `
        <div class="rounded-2xl p-8 shadow-2xl max-w-4xl mx-auto neon-border bg-white">
          <h2 class="text-3xl font-bold mb-8 flex items-center gap-3 text-gray-800">
            ‚úèÔ∏è INPUT PROBLEM
          </h2>
          
          <form id="problem-form" class="space-y-6" onsubmit="event.preventDefault(); submitProblem();">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="inisial">üë§ INISIAL PERSONIL *</label>
                <input type="text" id="inisial" value="${formData.inisial_personil}" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" required oninput="formData.inisial_personil = this.value.toUpperCase(); this.value = this.value.toUpperCase();">
              </div>

              <div>
                <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="departemen-input">üìÇ DEPARTEMEN *</label>
                <select id="departemen-input" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" required onchange="formData.departemen = this.value; renderApp();">
                  <option value="">PILIH DEPARTEMEN</option>
                  ${masterData.departemen.map(d => `<option value="${d}" ${formData.departemen === d ? 'selected' : ''}>${d}</option>`).join('')}
                </select>
              </div>

              <div>
                <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="mesin-input">‚öôÔ∏è MESIN</label>
                <select id="mesin-input" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" onchange="formData.mesin = this.value;">
                  <option value="">PILIH MESIN</option>
                  ${masterData.mesin.filter(m => {
                    const record = appData.masters.find(r => r.mesin === m && r.departemen === formData.departemen);
                    return record;
                  }).map(m => `<option value="${m}" ${formData.mesin === m ? 'selected' : ''}>${m}</option>`).join('')}
                </select>
              </div>

              <div>
                <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="produk">üì¶ NAMA PRODUK</label>
                <input type="text" id="produk" value="${formData.nama_produk}" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" oninput="formData.nama_produk = this.value.toUpperCase(); this.value = this.value.toUpperCase();">
              </div>

              <div>
                <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="kategori">üè∑Ô∏è KATEGORI PROBLEM *</label>
                <select id="kategori" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" required onchange="formData.kategori_problem = this.value;">
                  <option value="">PILIH KATEGORI</option>
                  <option value="QUALITY" ${formData.kategori_problem === 'QUALITY' ? 'selected' : ''}>‚ú® QUALITY</option>
                  <option value="PRODUCTIVITY" ${formData.kategori_problem === 'PRODUCTIVITY' ? 'selected' : ''}>‚ö° PRODUCTIVITY</option>
                  <option value="SAFETY" ${formData.kategori_problem === 'SAFETY' ? 'selected' : ''}>üõ°Ô∏è SAFETY</option>
                </select>
              </div>

              <div>
                <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="judul">üìù JUDUL PROBLEM *</label>
                <input type="text" id="judul" value="${formData.judul_problem}" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" placeholder="CONTOH: KAPLET PATAH" required oninput="formData.judul_problem = this.value.toUpperCase(); this.value = this.value.toUpperCase();">
              </div>
            </div>

            <div>
              <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="investigasi">üîç INVESTIGASI PROBLEM</label>
              <textarea id="investigasi" rows="4" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" placeholder="DESKRIPSIKAN PROBLEM YANG TERJADI SECARA DETAIL" oninput="formData.investigasi = this.value.toUpperCase(); this.value = this.value.toUpperCase();">${formData.investigasi}</textarea>
            </div>

            <div>
              <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="foto-kejadian">üì∏ UPLOAD FOTO KEJADIAN</label>
              <input type="file" id="foto-kejadian" accept="image/*" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" onchange="handleImageUpload(this.files[0]).then(data => formData.foto_kejadian = data);">
            </div>

            <div>
              <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="action-text">‚úÖ ACTION YANG DILAKUKAN</label>
              <textarea id="action-text" rows="4" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" placeholder="DESKRIPSIKAN ACTION YANG DILAKUKAN SECARA DETAIL" oninput="formData.action = this.value.toUpperCase(); this.value = this.value.toUpperCase();">${formData.action}</textarea>
            </div>

            <div>
              <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="foto-perbaikan">üì∏ UPLOAD FOTO PERBAIKAN</label>
              <input type="file" id="foto-perbaikan" accept="image/*" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" onchange="handleImageUpload(this.files[0]).then(data => formData.foto_perbaikan = data);">
            </div>

            <div>
              <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="evaluasi">‚≠ê EVALUASI HASIL</label>
              <textarea id="evaluasi" rows="4" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" placeholder="DESKRIPSIKAN HASIL ACTION YANG DILAKUKAN" oninput="formData.evaluasi = this.value.toUpperCase(); this.value = this.value.toUpperCase();">${formData.evaluasi}</textarea>
            </div>

            <button type="submit" id="submit-btn" class="w-full py-4 text-white rounded-xl font-black hover:opacity-90 transition shadow-2xl text-lg" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
              üíæ SIMPAN PROBLEM
            </button>
          </form>
        </div>
      `;
    }

    function renderManage() {
      if (!supabase) {
        return `<div class="rounded-2xl p-8 shadow-2xl text-center neon-border bg-white">
          <p class="text-gray-600">‚ö†Ô∏è Supabase belum dikonfigurasi</p>
        </div>`;
      }

      getMasterDataFromRecords();
      const masterRecords = appData.masters || [];

      if (!isAuthenticated) {
        return `
          <div class="rounded-2xl p-8 shadow-2xl max-w-md mx-auto neon-border bg-white">
            <h2 class="text-3xl font-bold mb-8 text-center flex items-center justify-center gap-3 text-gray-800">
              üîê LOGIN ADMIN
            </h2>
            <form id="login-form" class="space-y-6" onsubmit="event.preventDefault(); const pwd = document.getElementById('password').value; if (pwd.toUpperCase() === '${ADMIN_PASSWORD.toUpperCase()}') { isAuthenticated = true; resetInactivityTimer(); renderApp(); } else { showToast('‚ùå Password salah!', 'error'); }">
              <div>
                <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="password">üîë PASSWORD</label>
                <input type="password" id="password" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #3b82f6;" required>
              </div>
              <button type="submit" class="w-full py-4 text-white rounded-xl font-black hover:opacity-90 transition shadow-2xl text-lg" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                üöÄ LOGIN
              </button>
            </form>
          </div>
        `;
      }

      return `
        <div class="rounded-2xl p-8 shadow-2xl neon-border bg-white" onmousemove="resetInactivityTimer()" onclick="resetInactivityTimer()">
          <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold flex items-center gap-3 text-gray-800">
              ‚öôÔ∏è MANAGE MASTER DATA
            </h2>
            <button onclick="isAuthenticated = false; renderApp();" class="px-6 py-3 text-white rounded-xl hover:opacity-90 font-bold shadow-lg text-sm" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
              üö™ LOGOUT
            </button>
          </div>

          <form id="master-form" class="mb-8 p-6 border-2 rounded-2xl" style="border-color: #2563eb; background: rgba(59, 130, 246, 0.05);" onsubmit="event.preventDefault(); const form = this; submitMasterData({ departemen: form.dept.value, area: form.area.value, proses: form.proses.value, mesin: form.mesin.value }); form.reset();">
            <h3 class="text-xl font-bold mb-6 flex items-center gap-3 text-gray-800">
              ‚ûï TAMBAH MASTER DATA
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="dept">üìÇ DEPARTEMEN *</label>
                <select id="dept" name="dept" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #2563eb;" required>
                  <option value="">PILIH DEPARTEMEN</option>
                  <option value="LINE 01 A">LINE 01 A</option>
                  <option value="LINE 01 B">LINE 01 B</option>
                  <option value="LINE 02">LINE 02</option>
                  <option value="LINE 03">LINE 03</option>
                  <option value="LINE 04">LINE 04</option>
                  <option value="LINE 05">LINE 05</option>
                  <option value="LINE 07">LINE 07</option>
                  <option value="LINE 08">LINE 08</option>
                  <option value="LINE 09">LINE 09</option>
                </select>
              </div>
              <div>
                <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="area">üìç AREA *</label>
                <select id="area" name="area" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #2563eb;" required>
                  <option value="">PILIH AREA</option>
                  <option value="INJEKSI">üíâ INJEKSI</option>
                  <option value="NON INJEKSI">üîß NON INJEKSI</option>
                </select>
              </div>
              <div>
                <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="proses">üîß PROSES *</label>
                <input type="text" id="proses" name="proses" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #2563eb;" required>
              </div>
              <div>
                <label class="block mb-2 font-bold flex items-center gap-2 text-sm text-gray-700" for="mesin">‚öôÔ∏è NAMA MESIN *</label>
                <input type="text" id="mesin" name="mesin" class="w-full px-4 py-3 border-2 rounded-xl text-base text-gray-800" style="background: rgba(255,255,255,0.05); border-color: #2563eb;" required>
              </div>
            </div>
            <button type="submit" id="master-submit-btn" class="w-full mt-6 py-4 text-white rounded-xl font-black hover:opacity-90 transition shadow-2xl text-lg" style="background: linear-gradient(135deg, #2563eb 0%, #fb923c 100%);">
              üíæ SIMPAN
            </button>
          </form>

          <div class="space-y-4">
            <h3 class="text-xl font-bold flex items-center gap-3 text-gray-800">
              üìä DATA MASTER
            </h3>
            ${masterRecords.length === 0 ? `<p class="text-center py-8 opacity-70 text-gray-600">Belum ada master data</p>` : ''}
            ${masterRecords.map(r => `
              <div id="master-${r.id}" class="master-card p-6 rounded-xl shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label class="block text-xs mb-2 font-bold opacity-70 text-gray-700">üìÇ DEPARTEMEN</label>
                    <select disabled id="dept-${r.id}" class="w-full px-3 py-2 rounded-lg border text-sm text-gray-800" style="background: #f3f4f6; border-color: #d1d5db;">
                      <option value="LINE 01 A" ${r.departemen === 'LINE 01 A' ? 'selected' : ''}>LINE 01 A</option>
                      <option value="LINE 01 B" ${r.departemen === 'LINE 01 B' ? 'selected' : ''}>LINE 01 B</option>
                      <option value="LINE 02" ${r.departemen === 'LINE 02' ? 'selected' : ''}>LINE 02</option>
                      <option value="LINE 03" ${r.departemen === 'LINE 03' ? 'selected' : ''}>LINE 03</option>
                      <option value="LINE 04" ${r.departemen === 'LINE 04' ? 'selected' : ''}>LINE 04</option>
                      <option value="LINE 05" ${r.departemen === 'LINE 05' ? 'selected' : ''}>LINE 05</option>
                      <option value="LINE 07" ${r.departemen === 'LINE 07' ? 'selected' : ''}>LINE 07</option>
                      <option value="LINE 08" ${r.departemen === 'LINE 08' ? 'selected' : ''}>LINE 08</option>
                      <option value="LINE 09" ${r.departemen === 'LINE 09' ? 'selected' : ''}>LINE 09</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs mb-2 font-bold opacity-70 text-gray-700">üìç AREA</label>
                    <select disabled id="area-${r.id}" class="w-full px-3 py-2 rounded-lg border text-sm text-gray-800" style="background: #f3f4f6; border-color: #d1d5db;">
                      <option value="INJEKSI" ${r.area === 'INJEKSI' ? 'selected' : ''}>üíâ INJEKSI</option>
                      <option value="NON INJEKSI" ${r.area === 'NON INJEKSI' ? 'selected' : ''}>üîß NON INJEKSI</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs mb-2 font-bold opacity-70 text-gray-700">üîß PROSES</label>
                    <input disabled id="proses-${r.id}" type="text" value="${r.proses}" class="w-full px-3 py-2 rounded-lg border text-sm text-gray-800" style="background: #f3f4f6; border-color: #d1d5db;">
                  </div>
                  <div>
                    <label class="block text-xs mb-2 font-bold opacity-70 text-gray-700">‚öôÔ∏è NAMA MESIN</label>
                    <input disabled id="mesin-${r.id}" type="text" value="${r.mesin}" class="w-full px-3 py-2 rounded-lg border text-sm text-gray-800" style="background: #f3f4f6; border-color: #d1d5db;">
                  </div>
                </div>
                <div class="flex gap-3">
                  <button class="edit-btn flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition text-sm" onclick="toggleEditMaster(${r.id});">
                    ‚úèÔ∏è EDIT
                  </button>
                  <button class="delete-confirm-btn flex-1 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition text-sm" onclick="deleteMasterRecord(appData.masters.find(rec => rec.id === ${r.id}));">
                    üóëÔ∏è HAPUS
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderHistory() {
      if (!supabase) {
        return `<div class="rounded-2xl p-8 shadow-2xl text-center neon-border bg-white">
          <p class="text-gray-600">‚ö†Ô∏è Supabase belum dikonfigurasi</p>
        </div>`;
      }

      const historyRecords = appData.history || [];

      return `
        <div class="rounded-2xl p-8 shadow-2xl neon-border bg-white">
          <h2 class="text-3xl font-bold mb-8 flex items-center gap-3 text-gray-800">
            üìú HISTORY AKTIVITAS
          </h2>
          <div class="space-y-4">
            ${historyRecords.length === 0 ? `<p class="text-center py-12 opacity-70 text-gray-600">Belum ada history aktivitas</p>` : ''}
            ${historyRecords.map(h => `
              <div class="problem-card p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-start">
                  <p class="font-bold text-base text-gray-800">${h.activity_description}</p>
                  <span class="text-xs opacity-60 text-gray-600">üïê ${new Date(h.created_at).toLocaleString('id-ID')}</span>
                </div>
                ${h.departemen || h.mesin ? `
                  <div class="mt-3 flex gap-4 text-sm text-blue-600">
                    ${h.departemen ? `<span class="font-semibold">üìÇ ${h.departemen}</span>` : ''}
                    ${h.mesin ? `<span class="font-semibold">‚öôÔ∏è ${h.mesin}</span>` : ''}
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderApp() {
      const app = document.getElementById('app');

      app.innerHTML = `
        <div class="gradient-bg min-h-screen w-full p-6">
          <div class="max-w-7xl mx-auto">
            <h1 class="text-5xl font-black mb-8 text-center text-gray-800" style="text-shadow: 0 0 30px rgba(59, 130, 246, 0.3);">
              ‚ö° SOLVING NAVIGATOR
            </h1>

            <div class="flex flex-wrap gap-3 mb-8 justify-center">
              <button onclick="currentTab = 'dashboard'; renderApp();" class="tab-button px-8 py-4 rounded-2xl font-black transition shadow-2xl text-lg" style="background: ${currentTab === 'dashboard' ? 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' : 'rgba(255,255,255,0.5)'}; color: ${currentTab === 'dashboard' ? '#ffffff' : '#1f2937'};">
                üìä DASHBOARD
              </button>
              <button onclick="currentTab = 'input'; renderApp();" class="tab-button px-8 py-4 rounded-2xl font-black transition shadow-2xl text-lg" style="background: ${currentTab === 'input' ? 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' : 'rgba(255,255,255,0.5)'}; color: ${currentTab === 'input' ? '#ffffff' : '#1f2937'};">
                ‚úèÔ∏è INPUT
              </button>
              <button onclick="currentTab = 'manage'; renderApp();" class="tab-button px-8 py-4 rounded-2xl font-black transition shadow-2xl text-lg" style="background: ${currentTab === 'manage' ? 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' : 'rgba(255,255,255,0.5)'}; color: ${currentTab === 'manage' ? '#ffffff' : '#1f2937'};">
                ‚öôÔ∏è MANAGE DATA
              </button>
              <button onclick="currentTab = 'history'; renderApp();" class="tab-button px-8 py-4 rounded-2xl font-black transition shadow-2xl text-lg" style="background: ${currentTab === 'history' ? 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' : 'rgba(255,255,255,0.5)'}; color: ${currentTab === 'history' ? '#ffffff' : '#1f2937'};">
                üìú HISTORY
              </button>
            </div>

            <div id="content">
              ${currentTab === 'dashboard' ? renderDashboard() : currentTab === 'input' ? renderInput() : currentTab === 'manage' ? renderManage() : renderHistory()}
            </div>
          </div>
        </div>
      `;
    }

    // Initialize app
    initSupabase();
    renderApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ae3410382e0ccfd',t:'MTc2NTc3MzUzMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
